---
title: "CloudWatchã®ãƒ­ã‚°ã‚’Lambdaã§New Relicã«è»¢é€ã™ã‚‹"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws, cloudwatch, cloudwatchlogs, lambda, newrelic]
published: true
---

## ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦
CloudWatch Logsã®ãƒ­ã‚°ã‚’Lambdaã§New Relicã®Logsã«è»¢é€ã™ã‚‹æ‰‹é †ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚
New Relicã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ã¯ã“ã¡ã‚‰ã€‚

AWS Lambda for sending CloudWatch logs
https://docs.newrelic.com/docs/logs/forward-logs/aws-lambda-sending-cloudwatch-logs/

## New Relicãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã‚’ç¢ºèª
New Relicã® `API Keys` ã‹ã‚‰ç¢ºèªå¯èƒ½ã§ã™ã€‚

## AWS Serverless Application Repository
https://serverlessrepo.aws.amazon.com/applications

`newrelic-log-ingestion` ã¨å…¥åŠ›ã—ã€ `Show apps that create custom IAM roles or resource policies` ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™ã€‚
`NewRelic-log-ingestion` ã‚’é¸æŠã—ã¾ã™ã€‚

![](/images/0eb335db136437/lambda_01.png)

## NewRelic-log-ingestionãƒ‡ãƒ—ãƒ­ã‚¤
`Deploy`

![](/images/0eb335db136437/lambda_02.png)

`NRLicenseKey` ã«ç¢ºèªã—ãŸãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã€`NRLoggingEnabled` ã‚’ `True` ã¨ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãšã«ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ `false` ãªã®ã§å¿˜ã‚Œã‚‹ã¨ãƒ­ã‚°é£›ã³ã¾ã›ã‚“ã€‚
(ã“ã“ã§è¨­å®šã‚’å¿˜ã‚ŒãŸå ´åˆã¯ã€å¾Œã»ã©CFnã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰ãˆã¦åæ˜ ã•ã›ã‚Œã°OK)

`ã“ã®ã‚¢ãƒ—ãƒªãŒã‚«ã‚¹ã‚¿ãƒ  IAM ãƒ­ãƒ¼ãƒ«ã¨ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’æ‰¿èªã—ã¾ã™ã€‚` ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

![](/images/0eb335db136437/lambda_03.png)

![](/images/0eb335db136437/lambda_04.png)

CFnã§ä½œæˆã•ã‚Œã‚‹ãŸã‚ã€CFnã‚¹ã‚¿ãƒƒã‚¯ `serverlessrepo-NewRelic-log-ingestion` ã‹ã‚‰ã‚‚ç¢ºèªã§ãã¾ã™ã€‚
![](/images/0eb335db136437/lambda_05.png)

Lambdaé–¢æ•° `newrelic-log-ingestion` ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
![](/images/0eb335db136437/lambda_06.png)

## ãƒˆãƒªã‚¬ãƒ¼è¿½åŠ 
ä½œæˆã—ãŸLambda(newrelic-log-ingestion)ã‹ã‚‰ã€New Relicã«é£›ã°ã—ãŸã„CloudWatch Logsã®ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŒ‡å®šã™ã‚‹ã€‚

![](/images/0eb335db136437/trigger_01.png)

ãƒ†ã‚¹ãƒˆç”¨ã« `error` ã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½œæˆã—ã¦ã¿ã¾ã™ã€‚
ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã‚’å‚ç…§ã€‚

https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html

![](/images/0eb335db136437/trigger_02.png)

è¨­å®šå¾Œã€Lambdaã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚
![](/images/0eb335db136437/trigger_03.png)

ã¾ãŸã€CloudWatch Logså´ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚‚ç¢ºèªã§ãã¾ã™ã€‚
ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šã§ãã‚‹ã®ã¯æœ€å¤§2ã¤ã¾ã§ãªã®ã§æ³¨æ„ã€‚

![](/images/0eb335db136437/trigger_04.png)

## New Relicã«ãƒ­ã‚°ãŒè»¢é€ã•ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆ

è©²å½“ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã§ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œæˆã€‚

![](/images/0eb335db136437/log_01.png)

`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³` ã® `ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆ` ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¼•ã£ã‹ã‹ã‚‹ã‚ˆã†ãªãƒ­ã‚°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

![](/images/0eb335db136437/log_02.png)

![](/images/0eb335db136437/log_03.png)

![](/images/0eb335db136437/log_04.png)

æœ€å¾Œã«ã€New Relicã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã® `Logs` ã«é£›ã‚“ã§ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

![](/images/0eb335db136437/newrelic_01.png)

![](/images/0eb335db136437/newrelic_02.png)

NRQLã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§å¼•ã£ã‹ã‹ã‚Šã¾ã™ã€‚

```
SELECT count(*) FROM Log FACET aws.logGroup WHERE aws.accountId ='XXXXXXXXXX' AND message LIKE '%error%' AND aws.logGroup = '/aws/lambda/XXXXXXX'
```