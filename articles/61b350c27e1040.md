---
title: "SESã®é€ä¿¡å±¥æ­´ã‚’ç¢ºèªã—ãŸã„"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws, ses, amazonses, firehose, kinesisfirehose]
published: true
publication_name: "iret"
---

# ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦
Amazon SESã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡å±¥æ­´ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
ä»Šå›ã€Amazon SESã®é€ä¿¡å±¥æ­´ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã« `Amazon Kinesis Data Firehose + Amazon S3` æ§‹æˆã‚’è¨­å®šã—ã¦ã¿ã¾ã—ãŸã€‚
è¨­å®šã®æµã‚Œã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚
# OpenSearch Serviceã§ã¯ãªãS3ã‚’æ¡ç”¨
AWSãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ä»¥ä¸‹ã®ã‚µãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã€ `Amazon Kinesis Data Firehose + Amazon OpenSearch Service` ã§æ§‹æˆã™ã‚‹ã“ã¨ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã—ã‹ã—ã€OpenSearch Serviceã®æ–™é‡‘ãŒé«˜ãã€ä»Šå›ã¯ä¸æ¡ç”¨ã¨ã—ã¦ã„ã¾ã™ã€‚

>è§£æ±ºæ–¹æ³•
Amazon OpenSearch Service ã¨ Amazon Kinesis ã‚’ä½¿ç”¨ã—ã¦ã€Amazon SES é€ä¿¡å±¥æ­´ã‚’ä¿å­˜ãŠã‚ˆã³è¡¨ç¤ºã§ãã¾ã™ã€‚

https://aws.amazon.com/jp/premiumsupport/knowledge-center/ses-email-sending-history/

OpenSearch Serviceã®æ§‹æˆã«ã™ã‚‹ã¨ã€åˆ©ä¾¿æ€§(å¯èª­æ€§)ã¯è‰¯ã„ã§ã™ãŒã€ä¸€æ–¹ã§ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ã®ã§ã€ã¨ã‚Šã‚ãˆãšãƒ­ã‚°ã‚’å‡ºã—ã¦ãŠããŸã„ç”¨é€”ã ã‘ã§ã‚ã‚Œã°ã€S3ã«å‡ºåŠ›ã—ã¦ãŠãã ã‘ã§ã‚‚ååˆ†ã‹ã¨æ€ã„ã¾ã™ã€‚

https://aws.amazon.com/jp/opensearch-service/pricing/

# æ§‹æˆ
![](/images/61b350c27e1040/ses_01.png)

# è¨­å®šæ¦‚è¦

- é€ä¿¡å±¥æ­´ä¿ç®¡ç”¨S3ãƒã‚±ãƒƒãƒˆä½œæˆ
- é€ä¿¡å±¥æ­´è»¢é€ç”¨Firehoseé…ä¿¡ã‚¹ãƒˆãƒªãƒ¼ãƒ ä½œæˆ
- SES Configuration Setsç”¨IAMãƒ­ãƒ¼ãƒ«ä½œæˆ
- SES Configuration Setsè¨­å®š
- S3ã§ç¢ºèª

# é€ä¿¡å±¥æ­´ä¿ç®¡ç”¨S3ãƒã‚±ãƒƒãƒˆä½œæˆ
ç‰¹ã«ãƒã‚¤ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
å¿…è¦ãªè¨­å®šã§S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

# é€ä¿¡å±¥æ­´è»¢é€ç”¨Firehoseé…ä¿¡ã‚¹ãƒˆãƒªãƒ¼ãƒ ä½œæˆ
Destinationã‚’S3ã«ã™ã‚‹ã ã‘ã§ã€åŸºæœ¬çš„ã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§OKã§ã™ã€‚

| è¨­å®šé …ç›® | å†…å®¹ |
| --- | --- |
| Source | Direct PUT |
| Destination | Amazon S3 |
| S3 bucket | ä½œæˆã—ãŸS3ãƒã‚±ãƒƒãƒˆã‚’æŒ‡å®š |
| S3 bucket prefix | - |
| S3 bucket error output prefix | error/{firehose:error-output-type}/ |

`error-output-type` ã¯ã€å¤±æ•—ã®ç†ç”±ã«å¿œã˜ã¦ã€æ¬¡ã®æ–‡å­—åˆ—ã®ã„ãšã‚Œã‹ã¨ã—ã¦è©•ä¾¡ã•ã‚Œã‚‹ãŸã‚ã€ã“ã‚Œã ã‘è¨­å®šã—ã¦ãŠãã¾ã™ã€‚

- processing-failed
- AmazonOpenSearchService-failed
- splunk-failed
- format-conversion-failed
- http-endpoint-failed

https://docs.aws.amazon.com/ja_jp/firehose/latest/dev/s3-prefixes.html

# SES Configuration Setsç”¨IAMãƒ­ãƒ¼ãƒ«ä½œæˆ

## IAMãƒãƒªã‚·ãƒ¼
ãƒãƒªã‚·ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "0",
            "Effect": "Allow",
            "Action": "firehose:ListDeliveryStreams",
            "Resource": "*"
        },
        {
            "Sid": "1",
            "Effect": "Allow",
            "Action": "firehose:*",
            "Resource": "arn:aws:firehose:*:{accountid}:deliverystream/{deliverystream_name}"
        }
    ]
}
```

## IAMãƒ­ãƒ¼ãƒ«
ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ãƒãƒªã‚·ãƒ¼: ä¸Šè¨˜ä½œæˆã™ã‚‹IAMãƒãƒªã‚·ãƒ¼

ä¿¡é ¼ã•ã‚ŒãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
```
{
  "Version": "2012-10-17",
  "Statement": [
      {
            "Effect": "Allow",
            "Principal": {
                "Service": [
                    "ses.amazonaws.com"
                ]
            },
            "Action": "sts:AssumeRole",
            "Condition": {
                "StringEquals": {
                    "AWS:SourceAccount": "{accountid}",
                    "AWS:SourceArn": "arn:aws:ses:ap-northeast-1:{accountid}:configuration-set/{configurationset_name}"
                }
             }
      }
    ]
}
```
# SES Configuration Setsè¨­å®š
SES Configuration Setã‚’ä½œæˆã—ã€Destinationã¨ã—ã¦ä»¥ä¸‹ã‚’è¨­å®šã™ã‚‹ã€‚

[SESã‚³ãƒ³ã‚½ãƒ¼ãƒ«]â†’[ä½œæˆã—ãŸSES Configration Set]â†’[Event destinations]ã® `Add destination` ã‹ã‚‰è¨­å®šã—ã¦ã„ãã€‚

Event typesã«ã¤ã„ã¦ã¯ã€ä»Šå›ã¯å…¨ã¦é¸æŠã—ã¦ã„ã¾ã™ã€‚

```
- Sends
- Rendering failures
- Rejects
- Deliveries
- Hard bounces
- Complaints
- Delivery delays
- Subscriptions
- Opens
- Clicks
```

![](/images/61b350c27e1040/ses_eventtypes.png)

`Destination Type` ã¯ã€ä¸Šè¨˜ä½œæˆã—ãŸFirehoseé…ä¿¡ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é¸æŠã—ã€IAMãƒ­ãƒ¼ãƒ«ã«ä¸Šè¨˜ä½œæˆã—ãŸSES Configuration Setsç”¨IAMãƒ­ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚

è¨­å®šå®Œäº†ã—ãŸã‚‰ã€ãã®SES Configuration Setã‚’ã€è©²å½“SES identityã®Default configuration setã«è¨­å®šã—ã¾ã™ã€‚

![](/images/61b350c27e1040/ses_default_configrationnset.png)

# S3ã§ç¢ºèª
SESã‹ã‚‰ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã—ã¦ã¿ã¦ã€S3ã«SESã®é€ä¿¡å±¥æ­´ãŒå…¥ã£ã¦ãã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚Œã°OKã§ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªJSONãŒå…¥ã‚Šã¾ã™ã€‚

```
{
	"eventType": "Delivery",
	"mail": {
		"timestamp": "2022-07-26T04:20:30.136Z",
		"source": "aaa@bbb.com",
		"sourceArn": "arn:aws:ses:ap-northeast-1:{accountid}:identity/bbb.com",
		"sendingAccountId": "{accountid}",
		"messageId": "0106018238bc2338-965619e3-c059-4dae-a52d-2e6cd435c974-000000",
		"destination": [
			"xxx@xxx"
		],
		"headersTruncated": false,
		"headers": [
			{
				"name": "Date",
				"value": "Tue, 26 Jul 2022 04:20:30 +0000 (UTC)"
			},
			{
				"name": "From",
				"value": "aaa@bbb.com"
			},
			{
				"name": "To",
				"value": "xxx@zzz"
			},
			{
				"name": "Message-ID",
				"value": "<268354222.10805.1658809230082@68756d9cfa11>"
			},
			{
				"name": "Subject",
				"value": "XXXXXXX"
			},
			{
				"name": "MIME-Version",
				"value": "1.0"
			},
			{
				"name": "Content-Type",
				"value": "multipart/mixed;  boundary=\"----=_Part_10803_1198066364.1658809230080\""
			}
		],
		"commonHeaders": {
			"from": [
				"aaa@bbb.com"
			],
			"date": "Tue, 26 Jul 2022 04:20:30 +0000 (UTC)",
			"to": [
				"xxx@zzz"
			],
			"messageId": "XXXXXX-965619e3-c059-4dae-a52d-2e6cd435c974-000000",
			"subject": "XXXXXXXXXXX"
		},
		"tags": {
			"ses:operation": [
				"SendRawEmail"
			],
			"ses:configuration-set": [
				"{configurationset_name}"
			],
			"ses:source-ip": [
				"xx.xx.xx.xx"
			],
			"ses:from-domain": [
				"bbb.com"
			],
			"ses:caller-identity": [
				"xxx"
			],
			"ses:outgoing-ip": [
				"xx.xx.xx.xx"
			]
		}
	},
	"delivery": {
		"timestamp": "2022-07-26T04:20:33.705Z",
		"processingTimeMillis": 3569,
		"recipients": [
			"xxx@zzz"
		],
		"smtpResponse": "250 2.6.0 <0106018238bc2338-965619e3-c059-4dae-a52d-2e6cd435c974-000000@ap-northeast-1.amazonses.com> [InternalId=7473243098079, Hostname=xxx] 17068 bytes in 0.146, 113.697 KB/sec Queued mail for delivery",
		"reportingMTA": "e234-51.smtp-out.ap-northeast-1.amazonses.com"
	}
}
```
