---
title: "tfrefactorã‚’ä½¿ã£ã¦Terraform AWS Provider v4ã¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws, terraform]
published: true
publication_name: "iret"
---
## ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦
Terraformã®AWS Provider v4ã®ç ´å£Šçš„å¤‰æ›´ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ç‰¹ã«S3ã«ã¤ã„ã¦ã¯ `aws_s3_bucket` ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’åˆ†å‰²ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãªã©å½±éŸ¿ç¯„å›²ãŒå¤§ãã„ã§ã™ã€‚
v4ã¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹éš›ã«æ´»ç”¨ã§ãã‚‹ `tfrefactor` ã‚’ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚

### å‚è€ƒè¨˜äº‹

https://qiita.com/Shoyu_N/items/871ebf0c1d41493c22ac

## tfrefactor

https://github.com/anGie44/ohmyhcl/tree/main/tfrefactor

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã“ã¡ã‚‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã—ãŸã€‚

```
$ git clone https://github.com/anGie44/ohmyhcl
$ cd ohmyhcl/tfrefactor
$ go build -o path/to/bin/tfrefactor
```

## è©¦ã—ã¦ã¿ãŸ
### ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®æµã‚Œ

1. AWS Providerãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›¸ãæ›ãˆã¦ã€ `terraform init -upgrade` ã§åˆæœŸåŒ–
    - ä»Šå›ã¯ã€3.70.0 â†’ 4.33.0
2. `tfrefactor` ã§ `aws_s3_bucket` ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’åˆ†å‰²
3. æ–°è¦ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ `terraform import` ã™ã‚‹
4. `terraform plan` ã§å·®åˆ†ç¢ºèª


### å…ƒã¨ãªã‚‹s3.tf

```:s3.tf
# Bucket
resource "aws_s3_bucket" "sample" {
  bucket = "sample-bucket"
  acl    = "private"

  server_side_encryption_configuration {
    rule {
      apply_server_side_encryption_by_default {
        sse_algorithm = "AES256"
      }
    }
  }

  tags = {
    "Name" = "sample-bucket"
  }
}

# Bucket Public Access Block
resource "aws_s3_bucket_public_access_block" "sample" {
  bucket = aws_s3_bucket.sample.bucket
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

### tfrefactorå®Ÿè¡Œ

`-c` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ–°è¦ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§ã‚’csvå‡ºåŠ›ã§ãã¾ã™ã€‚

```
$ tfrefactor resource aws_s3_bucket s3.tf -c
```

### å®Ÿè¡Œã—ã¦ã§ããŸãƒ•ã‚¡ã‚¤ãƒ«

- s3_migrated.tf
- s3_new_resources.csv

```:s3_migrated.tf
# Bucket
resource "aws_s3_bucket" "sample" {
  bucket = "sample-bucket"
  tags = {
    "Name" = "sample-bucket"
  }
}

# Bucket Public Access Block
resource "aws_s3_bucket_public_access_block" "sample" {
  bucket = aws_s3_bucket.sample.bucket
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

resource "aws_s3_bucket_acl" "sample_acl" {
  bucket = aws_s3_bucket.sample.id
  acl    = "private"
}

resource "aws_s3_bucket_server_side_encryption_configuration" "sample_server_side_encryption_configuration" {
  bucket = aws_s3_bucket.sample.id
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}
```

```:s3_new_resources.csv
aws_s3_bucket_acl.sample_acl,aws_s3_bucket.sample
aws_s3_bucket_server_side_encryption_configuration.sample_server_side_encryption_configuration,aws_s3_bucket.sample
```

`aws_s3_bucket` ã®ä¸­ã«å«ã¾ã‚Œã¦ã„ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ aclã¨server_side_encryption_configurationãŒã€ `aws_s3_bucket_acl` ã¨ `aws_s3_bucket_server_side_encryption_configuration` ã¨ã„ã†åˆ¥ãƒªã‚½ãƒ¼ã‚¹ã«åˆ†å‰²ã•ã‚Œã¾ã—ãŸã€‚

### å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã™ã‚‹

```
$ mv s3.tf s3.tf.tmp
```

### ã“ã®çŠ¶æ…‹ã§terraform planã™ã‚‹ã¨

åˆ†å‰²ã•ã‚ŒãŸæ–°è¦ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹( `aws_s3_bucket_acl` , `aws_s3_bucket_server_side_encryption_configuration` )ãŒã€ãã®ã¾ã¾æ–°è¦ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ãªãƒ—ãƒ©ãƒ³ã¨ãªã£ã¦ã—ã¾ã†ãŸã‚ã€terraform importãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚

```
$ terraform plan

~

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the
following symbols:
  + create

Terraform will perform the following actions:

  # aws_s3_bucket_acl.sample_acl will be created
  + resource "aws_s3_bucket_acl" "sample_acl" {
      + acl    = "private"
      + bucket = "sample-bucket"
      + id     = (known after apply)

      + access_control_policy {
          + grant {
              + permission = (known after apply)

              + grantee {
                  + display_name  = (known after apply)
                  + email_address = (known after apply)
                  + id            = (known after apply)
                  + type          = (known after apply)
                  + uri           = (known after apply)
                }
            }

          + owner {
              + display_name = (known after apply)
              + id           = (known after apply)
            }
        }
    }

  # aws_s3_bucket_server_side_encryption_configuration.sample_server_side_encryption_configuration will be created
  + resource "aws_s3_bucket_server_side_encryption_configuration" "sample_server_side_encryption_configuration" {
      + bucket = "sample-bucket"
      + id     = (known after apply)

      + rule {
          + apply_server_side_encryption_by_default {
              + sse_algorithm = "AES256"
            }
        }
    }

Plan: 2 to add, 0 to change, 0 to destroy.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you
run "terraform apply" now.
```

## terraform import

tfrefactorã§ä½œæˆã—ãŸcsvãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ƒã«ã—ã¦ã€terraform importã‚³ãƒãƒ³ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒªã‚½ãƒ¼ã‚¹æ•°ãŒå¤šã„å ´åˆã¯åˆ¥é€”ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒ–ã—ãŸæ–¹ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸã€ãƒã‚±ãƒƒãƒˆACLã«ã¤ã„ã¦ã¯terraform importã™ã‚‹éš›ã«ã€è¨­å®šã«ã‚ˆã£ã¦æŒ‡å®šã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒç•°ãªã‚Šã¾ã™ã€‚
ä»Šå›ã¯å…ƒã€… `private` ã«ã—ã¦ã„ãŸãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒãƒ³ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

>$ terraform import aws_s3_bucket_acl.example bucket-name,private

https://registry.terraform.io/providers/hashicorp%20%20/aws/latest/docs/resources/s3_bucket_acl#import

```
$ terraform import aws_s3_bucket_acl.sample_acl sample-bucket,private
$ terraform import aws_s3_bucket_server_side_encryption_configuration.sample_server_side_encryption_configuration sample-bucket
```

## å·®åˆ†ç¢ºèª

ç„¡äº‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ããŸã‚‰ã€terraform planã—ã¦å·®åˆ†ãŒãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ terraform plan
~
No changes. Your infrastructure matches the configuration.
```

## å¾Œå§‹æœ«

S3ã®tfãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```
$ mv s3_migrated.tf s3.tf
```

ä¸è¦ã§ã‚ã‚Œã°ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

- s3.tf.tmp
- s3_new_resources.csv

## å‚è€ƒè¨˜äº‹

https://qiita.com/kjm/items/ad03eb832e250f2051bd