---
title: "CloudWatchã®ãƒ­ã‚°ã‚’Firehoseã§New Relicã«è»¢é€ã™ã‚‹"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws, cloudwatch, cloudwatchlogs, firehose, newrelic]
published: true
publication_name: "iret"
---

## ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦
Amazon CloudWatch Logsã®ãƒ­ã‚°ã‚’Amazon Kinesis Data Firehoseã§ã€New Relicã®Logsã«è»¢é€ã™ã‚‹æ‰‹é †ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚
ä»¥ä¸‹ã®è¨˜äº‹ã¯AWS Lambdaã§ã—ãŸãŒã€Amazon Kinesis Data Firehoseã§ã‚‚è»¢é€å¯èƒ½ã§ã™ã€‚

https://zenn.dev/isseeeeey55/articles/0eb335db136437

## New Relic Insert API Keyç¢ºèª
New Relicã® `API Keys` ã‹ã‚‰ `INGEST - LICENSE` ã‚’é¸æŠã—ã¾ã™ã€‚
`Copy key` ã‹ã‚‰API Keyã‚’ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚

**`USER` ã‚¿ã‚¤ãƒ—ã®APIã‚­ãƒ¼ã§ã¯ãªã„ã®ã§æ³¨æ„ã€‚**

![](/images/f576e426e98498/newrelic_apikey_01.png)

## S3ä½œæˆ
Firehoseã®é…ä¿¡ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç”¨ã«S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

## IAMä½œæˆ
### Firehoseç”¨ãƒ­ãƒ¼ãƒ«ä½œæˆ
- ãƒãƒªã‚·ãƒ¼ä½œæˆ
Firehoseã®é…ä¿¡ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç”¨ã«S3ã®ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:ListBucketMultipartUploads",
                "s3:AbortMultipartUpload",
                "s3:ListBucket",
                "s3:GetBucketLocation"
            ],
            "Resource": [
                "arn:aws:s3:::is55-test-newrelic/*",
                "arn:aws:s3:::is55-test-newrelic"
            ]
        }
    ]
}
```

![](/images/f576e426e98498/iam_01.png)

- ãƒ­ãƒ¼ãƒ«ä½œæˆ
Firehoseã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ãŸã‚ã®IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒãƒªã‚·ãƒ¼ã¯ä½œæˆã—ãŸS3ã®ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "firehose.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

![](/images/f576e426e98498/iam_02.png)

### CloudWatch Logsç”¨ãƒ­ãƒ¼ãƒ«ä½œæˆ
- ãƒãƒªã‚·ãƒ¼ä½œæˆ
Firehoseç”¨ã®ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
ä»Šå›ã¯ `firehose:*` ã§ä½œæˆã—ã¦ã„ã¾ã™ã€‚

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": "firehose:ListDeliveryStreams",
            "Resource": "*"
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": "firehose:*",
            "Resource": "arn:aws:firehose:ap-northeast-1:***************:deliverystream/is55-test-newrelic"
        }
    ]
}
```

![](/images/f576e426e98498/iam_03.png)

- ãƒ­ãƒ¼ãƒ«ä½œæˆ
CloudWatch Logsã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```
{
	"Version": "2012-10-17",
	"Statement": [
		{
			"Effect": "Allow",
			"Principal": {
			    "Service": "logs.ap-northeast-1.amazonaws.com"
			},
			"Action": "sts:AssumeRole"
		}
	]
}
```

![](/images/f576e426e98498/iam_04.png)


## Firehoseä½œæˆ
ä»¥ä¸‹ã®è¨­å®šã§Firehoseã®delivery streamã‚’ä½œæˆã—ã¾ã™ã€‚

|é …ç›®|å€¤|å‚™è€ƒ|
| --- | --- | --- |
|Source|Direct PUT||
|Destination|New Relic||
|HTTP endpoint URL|New Relic logs - US|https://aws-api.newrelic.com/firehose/v1|
|API Key|äº‹å‰ã«ç¢ºèªã—ãŸ `New Relic Insert API Key`||
|Source record backup in Amazon S3|Failed data only|æˆåŠŸãƒ­ã‚°ã‚‚æ ¼ç´ã™ã‚‹å ´åˆã¯ `All data` ã‚’é¸æŠ|
|S3 backup bucket|äº‹å‰ã«ä½œæˆã—ãŸS3ãƒã‚±ãƒƒãƒˆ||
|Permissions|äº‹å‰ã«ä½œæˆã—ãŸFirehoseç”¨ãƒ­ãƒ¼ãƒ«||

Destinationã«ã¯ `New Relic` ã‚’é¸æŠã—ã¾ã™ã€‚

![](/images/f576e426e98498/firehose_01.png)

HTTP endpoint URLã§ã¯ã€New Relicã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§åˆ†ã‹ã‚Œã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯Logsã® `US` ã‚’é¸æŠã—ã¾ã™ã€‚

![](/images/f576e426e98498/firehose_02.png)

ä¸Šè¨˜è¨­å®šé …ç›®ä»¥å¤–ã¯ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

![](/images/f576e426e98498/firehose_03.png)

## CloudWatch Logs
å¯¾è±¡ã¨ã™ã‚‹ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰ã€ `Kinesis Firehoseã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½œæˆ` ã‚’é¸æŠã—ã¾ã™ã€‚

![](/images/f576e426e98498/trigger_01.png)

ä½œæˆã—ãŸFirehoseã‚„CloudWatch Logsç”¨ãƒ­ãƒ¼ãƒ«ã‚’é¸æŠã—ã€å¿…è¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚
![](/images/f576e426e98498/trigger_02.png)

è¨­å®šå®Œäº†ã€‚
![](/images/f576e426e98498/trigger_03.png)

## ãƒ†ã‚¹ãƒˆ
è©²å½“ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¦ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```
[TEST] error message test
```

New Relicã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã® `Logs` ã«é£›ã‚“ã§ã„ã‚Œã°OKã§ã™ã€‚

![](/images/f576e426e98498/newrelic_01.png)

![](/images/f576e426e98498/newrelic_02.png)
